{% extends 'inicio/base_usuario.html' %}


{% block content %}
<h2>Perfil de {{ request.user.username }}</h2>
<p>Email:  {{ request.user.email }}</p>
<a href="{% url 'inicio' %}"><button>Ir al Inicio</button></a>

<hr>

<h3>Mi foto de perfil</h3>

{% if perfil.avatar %}
    <img src="{{ perfil.avatar.url }}" alt="Mi avatar" style="width: 100px; height: 100px; border-radius: 50%;">
{% endif %}

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Actualizar avatar</button>
</form>

{% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
    </ul>
{% endif %}


<h3>Mis publicaciones</h3>

{% if posts %}
    <ul>
        {% for post in posts %}
            <div style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
                <h3>{{ post.titulo }}</h3>
                <p>{{ post.contenido|linebreaksbr }}</p>

        {% if post.imagen %}
            <img src="{{ post.imagen.url }}" alt="Imagen del post" style="max-width: 100%; max-height: 300px; object-fit: cover; margin-top: 10px;">
        {% endif %}

        <p><strong>Likes:</strong> {{ post.likes.count }}</p>
        <small>Publicado el {{ post.fecha_publicacion|date:"d/m/Y H:i" }}</small><br>

        {% if request.user == post.autor %}
            <a href="{% url 'editar_post' post.id %}" class="btn btn-primary btn-sm">Editar</a>
            <a href="{% url 'eliminar_post' post.id %}" class="btn btn-danger btn-sm">Eliminar</a>
        {% elif request.user.is_superuser %}
            <a href="{% url 'eliminar_post' post.id %}" class="btn btn-danger btn-sm">Eliminar</a>
        {% endif %}

        <div style="margin-top: 10px; padding-left: 15px;">
            <strong>Comentarios:</strong>
            {% for comentario in post.comentarios.all %}
                <div>
                    <em>{{ comentario.autor.username }}:</em> {{ comentario.contenido }}
                </div>
            {% empty %}
                <p>No hay comentarios aún.</p>
            {% endfor %}
        </div>
    </div>
        {% endfor %}
    </ul>
{% else %}
    <p>No has publicado nada todavía.</p>
{% endif %}

<h3>Comentarios:</h3>
{% if comentarios %}
    <ul>
    {% for comentario in comentarios %}
        <li>"{{ comentario.contenido|truncatechars:100 }}" en <strong>{{ comentario.post.titulo }}</strong> ({{ comentario.fecha_publicacion }})</li>
    {% endfor %}
    </ul>
{% else %}
    <p>Este usuario no ha comentado aún.</p>
{% endif %}

{% endblock %}