{% extends 'inicio/base_usuario.html' %}
{% load static %}
{% load tz %}

{% block content %}

<nav>   
    <form action="{% url 'buscar_perfil' %}" method="get" class="d-flex">
        <input type="text" name="q" class="form-control me-2" placeholder="Buscar usuario..." required>
        <button type="submit" class="btn btn-primary">Buscar</button>
    </form>
</nav>

<h1>√öltimos Posts</h1>

<form method="get" style="margin-bottom: 15px;">
    <select name="filtro" onchange="this.form.submit()">
        <option value="">-- Ordenar/Filtrar --</option>
        <option value="fecha_desc" {% if request.GET.filtro == 'fecha_desc' %}selected{% endif %}>M√°s recientes</option>
        <option value="fecha_asc" {% if request.GET.filtro == 'fecha_asc' %}selected{% endif %}>M√°s antiguas</option>
        <option value="con_imagen" {% if request.GET.filtro == 'con_imagen' %}selected{% endif %}>Solo con imagen</option>
    </select>
</form>


{% for post in posts %}
<div style="border: 1px solid gray; padding: 10px; margin-bottom: 15px;">
    <h3>{{ post.titulo }}</h3>

    <div style="margin-bottom: 5px;">
        {% if user == post.autor %}
            <a href="{% url 'editar_post' post.id %}" class="btn btn-warning btn-sm">‚úèÔ∏è Editar</a>
        {% endif %}
        {% if user == post.autor or user.is_staff %}
            <a href="{% url 'eliminar_post' post.id %}" class="btn btn-danger btn-sm">üóëÔ∏è Eliminar</a>
        {% endif %}
    </div>

    <p>{{ post.contenido }}</p>

    {% if post.imagen %}
        <img src="{{ post.imagen.url }}" alt="Imagen del post" style="max-width: 400px; max-height: 300px;">
    {% endif %}

    {% if user.is_authenticated %}
        <button class="like-button-unificado" 
                data-id="{{ post.id }}" 
                data-tipo="post" 
                data-liked="{% if user in post.likes.all %}true{% else %}false{% endif %}" 
                style="background:none; border:none; padding:0; cursor:pointer;">
            <span class="icono-like">{% if user in post.likes.all %}‚ù§Ô∏è{% else %}‚ô°{% endif %}</span>
            <span class="like-count">{{ post.likes.count }}</span>
        </button>
    {% endif %}

    <small style="display: flex; align-items: center; gap: 10px;">
        {% if post.autor.perfil.avatar %}
            <img src="{{ post.autor.perfil.avatar.url }}" alt="Avatar de {{ post.autor.username }}" style="width: 32px; height: 32px; border-radius: 50%;">
        {% else %}
            <img src="/media/avatars/default.png" alt="Avatar por defecto" style="width: 32px; height: 32px; border-radius: 50%;">
        {% endif %}
        Publicado por {% if request.user == post.autor %}
            <a href="{% url 'mi_perfil' %}">{{ post.autor.username }}</a>
        {% else %}
            <a href="{% url 'perfil_usuario' post.autor.username %}">{{ post.autor.username }}</a>
        {% endif %}
    </small>

    <h4>Comentarios:</h4>
    {% if post.comentarios.exists %}
        {% for comentario in post.comentarios.all %}
            <div style="margin-left: 10px; margin-bottom: 8px;">
                <strong><a href="{% url 'perfil_usuario' comentario.autor.username %}">{{ comentario.autor.username }}</a></strong>:
                <p>{{ comentario.texto }}</p>

                {% if user.is_authenticated %}
                    <div style="margin-top: 4px;">
                        <button class="like-button-unificado" 
                                data-id="{{ comentario.id }}" 
                                data-tipo="comentario" 
                                data-liked="{% if user in comentario.likes.all %}true{% else %}false{% endif %}" 
                                style="background:none; border:none; padding:0; cursor:pointer;">
                            <span class="icono-like">{% if user in comentario.likes.all %}‚ù§Ô∏è{% else %}‚ô°{% endif %}</span>
                            <span class="like-count">{{ comentario.likes.count }}</span>
                        </button>
                    </div>
                {% endif %}

                <div style="margin-top: 4px;">
                    {% if user == comentario.autor %}
                        <a href="{% url 'editar_comentario' comentario.id %}" class="btn btn-warning btn-sm">‚úèÔ∏è Editar</a>
                    {% endif %}
                    {% if user == comentario.autor or user == post.autor or user.is_staff %}
                        <a href="{% url 'eliminar_comentario' comentario.id %}" class="btn btn-danger btn-sm">üóëÔ∏è Eliminar</a>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p>No hay comentarios.</p>
    {% endif %}

    {% if user.is_authenticated %}
        <form method="post" action="{% url 'agregar_comentario' post.id %}">
            {% csrf_token %}
            <textarea id="comentario-texto-{{ post.id }}" 
                      name="comentario" 
                      placeholder="Escrib√≠ un comentario..." 
                      rows="3" cols="50" maxlength="300"></textarea><br>
            <p><span id="contador-{{ post.id }}">300</span> caracteres restantes</p>
            <button type="submit">Agregar Comentario</button>
        </form>
    {% else %}
        <p><em>Inicia sesi√≥n para comentar.</em></p>
    {% endif %}
</div>
{% endfor %}

<!-- El resto de tus scripts de like y contador se mantienen igual -->
{% endblock %}
