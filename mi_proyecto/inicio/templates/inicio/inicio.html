{% extends 'inicio/base_usuario.html' %}
{% load static %}
{% load tz %}

{% block content %}

<nav>   
    <form action="{% url 'buscar_perfil' %}" method="get" class="d-flex">
        <input type="text" name="q" class="form-control me-2" placeholder="Buscar usuario..." required>
        <button type="submit" class="btn btn-primary">Buscar</button>
    </form>
</nav>

<div style="margin: 15px 0; display: flex; gap: 10px;">
    <a href="{% url 'mi_perfil' %}" class="btn btn-info">üë§ Mi Perfil</a>
    <a href="{% url 'crear_post' %}" class="btn btn-success">‚ûï Crear Post</a>
    <a href="{% url 'acerca_del_proyecto' %}" class="btn btn-info mb-3">
    ‚ÑπÔ∏è Acerca del Proyecto</a>
</div>

<h1>√öltimos Posts</h1>

<form method="get" style="margin-bottom: 15px;">
    <select name="filtro" onchange="this.form.submit()">
        <option value="">-- Ordenar/Filtrar --</option>
        <option value="fecha_desc" {% if request.GET.filtro == 'fecha_desc' %}selected{% endif %}>M√°s recientes</option>
        <option value="fecha_asc" {% if request.GET.filtro == 'fecha_asc' %}selected{% endif %}>M√°s antiguas</option>
        <option value="con_imagen" {% if request.GET.filtro == 'con_imagen' %}selected{% endif %}>Solo con imagen</option>
    </select>
</form>

{% if posts %}
    <ul style="list-style: none; padding: 0;">
    {% for post in posts %}
        <li style="margin-bottom: 20px; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
            <h3>{{ post.titulo }}</h3>
            <p>{{ post.contenido }}</p>

            {% if post.imagen %}
                <div style="margin-top: 10px;">
                    <img src="{{ post.imagen.url }}" alt="Imagen del post" style="max-width: 400px; max-height: 300px;">
                </div>
            {% endif %}

            {% if user.is_authenticated %}
                <span id="like-button-{{ post.id }}"
                      onclick="toggleLike('{{ post.id }}', 'post')" 
                      style="cursor:pointer; font-size: 18px; margin-right: 5px;">
                    {% if user in post.likes.all %}‚ù§Ô∏è{% else %}‚ô°{% endif %}
                </span>
                <span id="like-count-{{ post.id }}">{{ post.likes.count }}</span>
            {% endif %}

            <!-- Opciones editar/borrar para posts -->
            {% if request.user == post.autor %}
                <a href="{% url 'editar_post' post.id %}?next={{ request.path }}" 
                    class="btn btn-sm btn-warning">‚úèÔ∏è Editar</a>
                <a href="{% url 'eliminar_post' post.id %}?next={{ request.path }}" 
                    class="btn btn-sm btn-danger">üóëÔ∏è Borrar</a>
            {% elif request.user.is_superuser %}
                <a href="{% url 'eliminar_post' post.id %}?next={{ request.path }}" 
                class="btn btn-sm btn-danger">üóëÔ∏è Borrar</a>
            {% endif %}

            <small style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                {% if post.autor.perfil.avatar %}
                    <img src="{{ post.autor.perfil.avatar.url }}" alt="Avatar de {{ post.autor.username }}" style="width: 32px; height: 32px; border-radius: 50%;">
                {% else %}
                    <img src="/media/avatars/default.png" alt="Avatar por defecto" style="width: 32px; height: 32px; border-radius: 50%;">
                {% endif %}
                Publicado por 
                {% if request.user == post.autor %}
                    <a href="{% url 'mi_perfil' %}">{{ post.autor.username }}</a>
                {% else %}
                    <a href="{% url 'perfil_usuario' post.autor.username %}">{{ post.autor.username }}</a>
                {% endif %}
                ‚Äî {{ post.fecha_publicacion|date:"d/m/Y H:i" }}
            </small>

            <hr>
            <strong>Comentarios:</strong>
            {% for comentario in post.comentarios.all %}
                <div style="border-bottom: 1px solid #ddd; padding: 5px 0;">
                    <em>
                        {% if request.user == comentario.autor %}
                            <a href="{% url 'mi_perfil' %}">{{ comentario.autor.username }}</a>
                        {% else %}
                            <a href="{% url 'perfil_usuario' comentario.autor.username %}">{{ comentario.autor.username }}</a>
                        {% endif %}
                    </em>: {{ comentario.texto }}

                    {% if user.is_authenticated %}
                        <span id="like-button-{{ comentario.id }}"
                              onclick="toggleLike('{{ comentario.id }}', 'comentario')" 
                              style="cursor:pointer; font-size: 16px; margin-left: 8px;">
                            {% if user in comentario.likes.all %}‚ù§Ô∏è{% else %}‚ô°{% endif %}
                        </span>
                        <span id="like-count-{{ comentario.id }}">{{ comentario.likes.count }}</span>
                    {% endif %}

                    {% if request.user == comentario.autor %}
                        <a href="{% url 'editar_comentario' comentario.id %}?next={{ request.path }}" class="btn btn-sm btn-warning">Editar</a>
                        <a href="{% url 'eliminar_comentario' comentario.id %}?next={{ request.path }}" class="btn btn-sm btn-danger">Borrar</a>
                    {% elif request.user.is_superuser %}
                        <a href="{% url 'eliminar_comentario' comentario.id %}?next={{ request.path }}" class="btn btn-sm btn-danger">Borrar</a>
                    {% endif %}
                </div>
            {% empty %}
                <p>No hay comentarios a√∫n.</p>
            {% endfor %}

            {% if user.is_authenticated %}
                <form method="post" action="{% url 'agregar_comentario' post.id %}" style="margin-top: 10px;">
                    {% csrf_token %}
                    <textarea 
                        name="comentario" 
                        rows="2" 
                        cols="40" 
                        maxlength="300" 
                        oninput="updateCounter(this, 'contador-{{ post.id }}')" 
                        placeholder="Escribe un comentario..." 
                        required></textarea>
                    <div>
                        <small id="contador-{{ post.id }}">300</small> caracteres restantes
                    </div>
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <button type="submit">Comentar</button>
                </form>
            {% endif %}
        </li>
    {% endfor %}
    </ul>
{% else %}
    <p>No hay publicaciones.</p>
{% endif %}

<script>
function toggleLike(objetoId, tipo) {
    fetch("{% url 'toggle_like_unificado' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ id: objetoId, tipo: tipo })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById(`like-count-${objetoId}`).innerText = data.likes_count;
        document.getElementById(`like-button-${objetoId}`).innerText = data.liked ? "‚ù§Ô∏è" : "‚ô°";
    })
    .catch(error => console.error('Error:', error));
}

function updateCounter(textarea, counterId) {
    const maxLength = textarea.getAttribute("maxlength");
    const currentLength = textarea.value.length;
    document.getElementById(counterId).textContent = maxLength - currentLength;
}
</script>


<footer class="bg-dark text-white text-center py-3 mt-4">
    <div class="container">
        <p class="mb-1">üíª Soporte T√©cnico: cont√°ctanos si necesitas ayuda</p>
        <p class="mb-0">
            üìß Correo: 
            <a href="mailto:soporte@gmail.com" class="text-info">soporte@gmail.com</a>
        </p>
    </div>
</footer>



{% endblock %}
